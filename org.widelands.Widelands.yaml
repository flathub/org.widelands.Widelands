app-id: org.widelands.Widelands
runtime: org.freedesktop.Platform
runtime-version: '18.08'
sdk: org.freedesktop.Sdk
command: widelands
rename-icon: org.widelands.Widelands
finish-args:
  # X11 + XShm access
  - --share=ipc
  - --socket=x11
  # Play sounds
  - --socket=pulseaudio
  # Needs to talk to the network
  - --share=network
  - --persist=.widelands
  # OpenGL access
  - --device=dri
cleanup:
  - /include
  - /lib/pkgconfig
  - /share/man
  - '*.la'
  - '*.a'
modules:
  - shared-modules/lua5.3/lua-5.3.2.json
  - shared-modules/glu/glu-9.0.0.json
  - shared-modules/glew/glew.json

  - name: boost
    buildsystem: simple
    build-commands:
      - ./bootstrap.sh --prefix="${FLATPAK_DEST}" --with-libraries=filesystem,system,signals,regex,test
      - ./b2 headers
      - ./b2 install
    sources:
      - type: archive
        url: https://dl.bintray.com/boostorg/release/1.68.0/source/boost_1_68_0.tar.bz2
        sha256: 7f6130bc3cf65f56a618888ce9d5ea704fa10b462be126ad053e80e553d6d8b7

  - name: Widelands
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DCMAKE_INSTALL_PREFIX=/app/bin
      - -DWL_INSTALL_BASEDIR=/app/share/widelands
      - -DWL_INSTALL_DATADIR=/app/share/widelands
      - -DBOOST_ROOT=/app
      - -DGLEW_ROOT=/app
      - -DGLEW_INCLUDE_DIR=/app/include/GL
      # https://wl.widelands.org/forum/topic/1343/?page=3 & https://wl.widelands.org/forum/post/9857/
      - -DGLEW_LIBRARY:FILEPATH=/app/lib/libGLEW.a
      - -DOPENGL_glu_LIBRARY=/app/lib/libGLU.a
      - -DOPTION_BUILD_WEBSITE_TOOLS=OFF
    post-install:
      - for s in {16,32,48,64,128}; do
        install -p -D -m 0644 "../data/images/logos/wl-ico-${s}.png" "${FLATPAK_DEST}/share/icons/hicolor/${s}x${s}/apps/${FLATPAK_ID}.png";
        done;
      - install -p -D -m 0644 "../debian/org.widelands.widelands.desktop" "${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop"
      - install -p -D -m 0644 "../debian/widelands.appdata.xml" "${FLATPAK_DEST}/share/metainfo/${FLATPAK_ID}.appdata.xml"
    cleanup:
      - /bin/wl_render_richtext
    sources:
      - type: archive
        url: https://launchpad.net/widelands/build19/build19/+download/widelands-build19-src-gcc7.tar.bz2
        sha256: ef73b8cf5a7c680bad5caade907f1cc6ee88dd3729470b9214a3c72658585458
      - type: file
        path: widelands.appdata.xml
        dest: debian
      # https://bugs.launchpad.net/widelands/+bug/1760581
      - type: patch
        path: widelands-build19-icu-bidi.patch
      # https://github.com/hughsie/appstream-glib/pull/272#issuecomment-439812546
      - type: patch
        path: widelands-build19-appdata-vercmp.patch
